<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FactoryDash - Real-Time Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container mt-4">
        <h1>Real-Time Manufacturing Dashboard</h1>

        <!-- Last Updated Indicator -->
        <div class="mb-3">
            <small>Last Updated: <span id="last-updated">{% if last_updated %}{{ last_updated|date:"Y-m-d H:i:s" }}{% else %}N/A{% endif %}</span></small>
            <span id="live-indicator" class="badge bg-success ms-2">Live</span>
        </div>

        <!-- Data Table -->
        <div class="row mt-4">
            <div class="col">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Machine ID</th>
                            <th>Parameter</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody id="data-table">
                        <!-- Table rows will be added here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // WebSocket for real-time updates
        const socketProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const socketHost = window.location.host || '127.0.0.1:8080';  // Fallback for local dev
        const socket = new WebSocket(`${socketProtocol}${socketHost}/ws/dashboard/`);

        socket.onopen = function() { console.log('WebSocket connected'); };

        socket.onmessage = function(e) {
            console.log('Message received:', e.data);
            try {
                const data = JSON.parse(e.data);

                // Update Last Updated
                const lastUpdated = document.getElementById('last-updated');
                if (lastUpdated) {
                    lastUpdated.innerText = data.last_updated || 'N/A';
                }

                // Update Table
                const tableBody = document.getElementById('data-table');
                if (tableBody && data.table_data) {
                    tableBody.innerHTML = ''; // Clear existing rows
                    data.table_data.forEach(item => {
                        const row = tableBody.insertRow();
                        const timestampCell = row.insertCell();
                        const machineIdCell = row.insertCell();
                        const parameterCell = row.insertCell();
                        const valueCell = row.insertCell();

                        timestampCell.innerText = item.timestamp;
                        machineIdCell.innerText = item.data_item_id;
                        parameterCell.innerText = item.name;
                        valueCell.innerText = item.value;
                    });
                }
            } catch (err) {
                console.error('JSON parse error:', err, 'Raw data:', e.data);
            }
        };

        socket.onerror = function(e) { console.error('WebSocket error:', e); };
        socket.onclose = function(e) { console.log('WebSocket closed:', e); };
    </script>
</body>
</html>
